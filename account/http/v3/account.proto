syntax = "proto3";

package smart_kart.account.http.v3;

option go_package = "github.com/smart-kart/proto/gen/go/account/http/v3;accountv3";

import "google/api/annotations.proto";

// AccountHTTPService provides HTTP v3 endpoints for account management
service AccountHTTPService {
  // InitiateRegistration - Step 1: User enters email or phone, receives OTP
  rpc InitiateRegistration(InitiateRegistrationRequest) returns (InitiateRegistrationResponse) {
    option (google.api.http) = {
      post: "/v3/user/register/initiate"
      body: "*"
    };
  }

  // VerifyRegistrationOTP - Step 2: User verifies OTP sent to email/phone
  rpc VerifyRegistrationOTP(VerifyRegistrationOTPRequest) returns (VerifyRegistrationOTPResponse) {
    option (google.api.http) = {
      post: "/v3/user/register/verify-otp"
      body: "*"
    };
  }

  // CompleteRegistration - Step 3: User provides name & password, account created & auto-login
  rpc CompleteRegistration(CompleteRegistrationRequest) returns (CompleteRegistrationResponse) {
    option (google.api.http) = {
      post: "/v3/user/register/complete"
      body: "*"
    };
  }

  // LoginUser login a user (accepts email OR phone + password)
  rpc LoginUser(LoginUserRequest) returns(LoginUserResponse) {
    option (google.api.http) = {
      post: "/v3/user/login"
      body: "*"
    };
  }
  // LoginWithPhone login a user (OTP-based login)
  rpc LoginWithPhone(LoginWithPhoneRequest) returns(LoginUserResponse) {
    option (google.api.http) = {
      post: "/v3/user/login-with-phone"
      body: "*"
    };
  }

  // GoogleAuth authenticates or creates a user via Google OAuth
  rpc GoogleAuth(GoogleAuthRequest) returns(GoogleAuthResponse) {
    option (google.api.http) = {
      post: "/v3/user/google-auth"
      body: "*"
    };
  }

  // LinkGoogleAccount links a Google account to an existing password account
  rpc LinkGoogleAccount(LinkGoogleAccountRequest) returns(LinkGoogleAccountResponse) {
    option (google.api.http) = {
      post: "/v3/user/link-google"
      body: "*"
    };
  }

  // AdminLogin retrieves an account by ID via HTTP
  rpc AdminLogin(AdminLoginRequest) returns (AdminLoginResponse) {
    option (google.api.http) = {
      post: "/v3/admin/login"
      body: "*"
    };
  }

  // ConfigAccount updates an existing account via HTTP
  rpc ConfigUser(ConfigUserRequest) returns (ConfigUserResponse) {
    option (google.api.http) = {
      post: "/v3/user/config/{user_id}"
      body: "*"
    };
  }

  // SendVerificationEmail sends a verification email to the user
  rpc SendVerificationEmail(SendVerificationEmailRequest) returns (SendVerificationEmailResponse) {
    option (google.api.http) = {
      post: "/v3/account/send-verification-email"
      body: "*"
    };
  }

  // VerifyEmail verifies a user's email using the verification token
  rpc VerifyEmail(VerifyEmailRequest) returns (VerifyEmailResponse) {
    option (google.api.http) = {
      post: "/v3/account/verify-email"
      body: "*"
    };
  }

  // SendVerificationSMS sends a verification SMS to the user
  rpc SendVerificationSMS(SendVerificationSMSRequest) returns (SendVerificationSMSResponse) {
    option (google.api.http) = {
      post: "/v3/account/send-verification-sms"
      body: "*"
    };
  }

  // VerifyPhone verifies a user's phone using the verification OTP
  rpc VerifyPhone(VerifyPhoneRequest) returns (VerifyPhoneResponse) {
    option (google.api.http) = {
      post: "/v3/account/verify-phone"
      body: "*"
    };
  }

  // ForgetPassword sends a password reset email to the user
  rpc ForgetPassword(ForgetPasswordRequest) returns (ForgetPasswordResponse) {
    option (google.api.http) = {
      post: "/v3/user/forgot-password"
      body: "*"
    };
  }

  // ResetPassword verifies token and sets new password
  rpc ResetPassword(ResetPasswordRequest) returns (ResetPasswordResponse) {
    option (google.api.http) = {
      post: "/v3/user/reset-password"
      body: "*"
    };
  }

  // GetUser retrieves a user's profile information
  rpc GetUser(GetUserRequest) returns (GetUserResponse) {
    option (google.api.http) = {
      get: "/v3/user/{user_id}"
    };
  }

  // Logout revokes the user's refresh token
  rpc Logout(LogoutRequest) returns (LogoutResponse) {
    option (google.api.http) = {
      post: "/v3/user/logout"
      body: "*"
    };
  }

  // RefreshToken generates a new access token from a refresh token
  rpc RefreshToken(RefreshTokenRequest) returns (RefreshTokenResponse) {
    option (google.api.http) = {
      post: "/v3/user/refresh-token"
      body: "*"
    };
  }

  // RefreshTokenSilent refreshes access token using httpOnly cookie
  rpc RefreshTokenSilent(EmptyRequest) returns (RefreshTokenSilentResponse) {
    option (google.api.http) = {
      post: "/v3/user/refresh-silent"
      body: "*"
    };
  }

  // ========== ADDRESS MANAGEMENT ==========

  // AddAddress adds a new shipping/billing address for the user
  rpc AddAddress(AddAddressRequest) returns (AddAddressResponse) {
    option (google.api.http) = {
      post: "/v3/user/addresses"
      body: "*"
    };
  }

  // GetAddress retrieves a specific address by ID
  rpc GetAddress(GetAddressRequest) returns (GetAddressResponse) {
    option (google.api.http) = {
      get: "/v3/user/addresses/{address_id}"
    };
  }

  // ListAddresses retrieves all addresses for the authenticated user
  rpc ListAddresses(ListAddressesRequest) returns (ListAddressesResponse) {
    option (google.api.http) = {
      get: "/v3/user/addresses"
    };
  }

  // UpdateAddress updates an existing address
  rpc UpdateAddress(UpdateAddressRequest) returns (UpdateAddressResponse) {
    option (google.api.http) = {
      put: "/v3/user/addresses/{address_id}"
      body: "*"
    };
  }

  // DeleteAddress deletes an address
  rpc DeleteAddress(DeleteAddressRequest) returns (DeleteAddressResponse) {
    option (google.api.http) = {
      delete: "/v3/user/addresses/{address_id}"
    };
  }

  // SetDefaultAddress sets an address as the default for shipping/billing
  rpc SetDefaultAddress(SetDefaultAddressRequest) returns (SetDefaultAddressResponse) {
    option (google.api.http) = {
      put: "/v3/user/addresses/{address_id}/set-default"
      body: "*"
    };
  }
}

// LoginWithPhoneRequest represents the HTTP v3 request to login with phone number
// If otp is not provided, an OTP will be sent to the phone number
// If otp is provided, it will verify the OTP and complete the login
message LoginWithPhoneRequest {
  string phone_number = 1 [json_name = "phone_number"]; // @gotags: validate:"required"
  optional string otp = 2 [json_name = "otp"]; // @gotags: validate:"omitempty,len=6"
}

// ForgetPasswordRequest represents the HTTP v3 request to forget password
message ForgetPasswordRequest {
  string email = 1 [json_name = "email"];
}

// ForgetPasswordResponse represents the HTTP v3 response to forget password
message ForgetPasswordResponse {
  string message = 1 [json_name = "message"];
}

// ResetPasswordRequest represents the HTTP v3 request to reset password
message ResetPasswordRequest {
  string token = 1 [json_name = "token"]; // @gotags: validate:"required"
  string new_password = 2 [json_name = "new_password"]; // @gotags: validate:"required,min=8"
  string confirm_password = 3 [json_name = "confirm_password"]; // @gotags: validate:"required,eqfield=NewPassword"
}

// ResetPasswordResponse represents the HTTP v3 response to reset password
message ResetPasswordResponse {
  bool success = 1 [json_name = "success"];
  string message = 2 [json_name = "message"];
}

// Account represents an account entity in HTTP v3
message Account {
  string user_id = 1;
  optional string email = 2; // Optional because user might register with phone only
  optional string phone_number = 3; // Optional because user might register with email only
  optional string full_name = 4 [json_name = "full_name"]; // User's full name
  optional string profile_picture_url = 5 [json_name = "profile_picture_url"];
  string status = 6;
  bool email_verified = 7 [json_name = "email_verified"];
  bool phone_verified = 8 [json_name = "phone_verified"];
  bool is_oauth_only = 9 [json_name = "is_oauth_only"];
  string created_at = 10;
  string updated_at = 11;
}

// Token represents JWT authentication tokens
message Token {
  string access_token = 1 [json_name = "access_token"];
  string refresh_token = 2 [json_name = "refresh_token"];
  string token_type = 3 [json_name = "token_type"]; // e.g., "Bearer"
}

// LoginuserRequest represents login request
// email_or_phone can be email address or phone number (auto-detected)
message LoginUserRequest {
  string email_or_phone = 1 [json_name = "email_or_phone"]; // @gotags: validate:"required"
  string password = 2 [json_name = "password"]; // @gotags: validate:"required,min=8"
}

// LoginUserResponse represents the HTTP v3 response for login
message LoginUserResponse {
  string message = 1;
  optional Token token = 2;
  optional Account account = 3;
}

// GoogleAuthRequest represents the HTTP v3 request for Google OAuth
message GoogleAuthRequest {
  string id_token = 1 [json_name = "id_token"]; // @gotags: validate:"required"
  bool is_signup = 2 [json_name = "is_signup"]; // true for signup, false for signin
}

// GoogleAuthResponse represents the HTTP v3 response for Google OAuth
message GoogleAuthResponse {
  string message = 1;
  optional Account account = 2;
  optional Token token = 3;
}

// LinkGoogleAccountRequest represents the HTTP v3 request to link Google account
message LinkGoogleAccountRequest {
  string id_token = 1 [json_name = "id_token"]; // @gotags: validate:"required"
  string email = 2 [json_name = "email"]; // @gotags: validate:"required,email"
  string password = 3 [json_name = "password"]; // @gotags: validate:"required"
}

// LinkGoogleAccountResponse represents the HTTP v3 response for linking Google account
message LinkGoogleAccountResponse {
  string message = 1;
  optional Account account = 2;
  optional Token token = 3;
}

// AdminLoginRequest represents the HTTP v3 request to login admin
message AdminLoginRequest {
  string email = 1 [json_name = "email"]; // @gotags: validate:"required,email"
  string password = 2 [json_name = "password"]; // @gotags: validate:"required,min=8"
}

// AdminLoginResponse represents the HTTP v3 response for login admin
message AdminLoginResponse {
  string message = 1;
  optional Token token = 2;
  optional Account account = 3;
  repeated string permissions = 4 [json_name = "permissions"]; // Admin permissions
}

// ConfigUserRequest represents the HTTP v3 request to update an account
message ConfigUserRequest {
  string user_id = 1 [json_name = "user_id"];
  optional string email = 2 [json_name = "email"];
  optional string phone_number = 3 [json_name = "phone_number"];
  optional string full_name = 4 [json_name = "full_name"];
  optional string old_password = 5 [json_name = "old_password"];
  optional string new_password = 6 [json_name = "new_password"];
}

// ConfigUserResponse represents the HTTP v3 response for updating an account
message ConfigUserResponse {
  string message = 1;
  optional Account account = 2;
}

// DeleteAccountRequest represents the HTTP v3 request to delete an account
message DeleteAccountRequest {
  string account_id = 1;
}

// DeleteAccountResponse represents the HTTP v3 response for deleting an account
message DeleteAccountResponse {
  bool success = 1;
  string message = 2;
}

// ListAccountsRequest represents the HTTP v3 request to list accounts
message ListAccountsRequest {
  int32 limit = 1;
  int32 offset = 2;
  optional string status_filter = 3;
  optional string user_id_filter = 4;
}

// ListAccountsResponse represents the HTTP v3 response for listing accounts
message ListAccountsResponse {
  repeated Account accounts = 1;
  int32 total_count = 2;
  int32 limit = 3;
  int32 offset = 4;
}

// SendVerificationEmailRequest represents the HTTP v3 request to send verification email
message SendVerificationEmailRequest {
  string email = 1 [json_name = "email"]; // @gotags: validate:"required,email"
}

// SendVerificationEmailResponse represents the HTTP v3 response for sending verification email
message SendVerificationEmailResponse {
  string message = 1;
}

// VerifyEmailRequest represents the HTTP v3 request to verify email
message VerifyEmailRequest {
  string email = 1 [json_name = "email"]; // @gotags: validate:"required,email"
  string otp = 2 [json_name = "otp"]; // @gotags: validate:"required,len=6"
}

// VerifyEmailResponse represents the HTTP v3 response for verifying email
message VerifyEmailResponse {
  bool success = 1;
  string message = 2;
}

// SendVerificationSMSRequest represents the HTTP v3 request to send verification SMS
message SendVerificationSMSRequest {
  string phone_number = 1 [json_name = "phone_number"]; // @gotags: validate:"required"
}

// SendVerificationSMSResponse represents the HTTP v3 response for sending verification SMS
message SendVerificationSMSResponse {
  string message = 1;
}

// VerifyPhoneRequest represents the HTTP v3 request to verify phone
message VerifyPhoneRequest {
  string phone_number = 1 [json_name = "phone_number"]; // @gotags: validate:"required"
  string otp = 2 [json_name = "otp"]; // @gotags: validate:"required,len=6"
}

// VerifyPhoneResponse represents the HTTP v3 response for verifying phone
message VerifyPhoneResponse {
  bool success = 1;
  string message = 2;
}

// GetUserRequest represents the HTTP v3 request to get user information
message GetUserRequest {
  string user_id = 1 [json_name = "user_id"]; // @gotags: validate:"required"
}

// GetUserResponse represents the HTTP v3 response for getting user information
message GetUserResponse {
  Account account = 1;
  string message = 2;
}

// LogoutRequest represents the HTTP v3 request to logout
message LogoutRequest {
  optional string user_id = 1 [json_name = "user_id"];
  optional string refresh_token = 2 [json_name = "refresh_token"];
}

// LogoutResponse represents the HTTP v3 response for logout
message LogoutResponse {
  bool success = 1;
  string message = 2;
}

// RefreshTokenRequest represents the HTTP v3 request to refresh access token
message RefreshTokenRequest {
  string refresh_token = 1 [json_name = "refresh_token"]; // @gotags: validate:"required"
}

// RefreshTokenResponse represents the HTTP v3 response for refreshing token
message RefreshTokenResponse {
  Token token = 1;
  string message = 2;
}

// Empty request for endpoints that don't need parameters
message EmptyRequest {}

// Response for silent refresh (cookie-based)
message RefreshTokenSilentResponse {
  string access_token = 1;  // Only access token in response body
  string message = 2;
  // Refresh token is in httpOnly cookie (not in response body)
}

// ===== New 3-Step Registration Flow Messages =====

// InitiateRegistrationRequest - Step 1: User enters email OR phone
message InitiateRegistrationRequest {
  string email_or_phone = 1 [json_name = "email_or_phone"]; // @gotags: validate:"required"
}

// InitiateRegistrationResponse - Step 1 response with session token
message InitiateRegistrationResponse {
  string message = 1;
  string session_token = 2 [json_name = "session_token"]; // Temporary token to track registration flow
  string contact_type = 3 [json_name = "contact_type"]; // "email" or "phone"
  string masked_contact = 4 [json_name = "masked_contact"]; // e.g., "j***@example.com" or "+91-9876***210"
}

// VerifyRegistrationOTPRequest - Step 2: User enters OTP
message VerifyRegistrationOTPRequest {
  string session_token = 1 [json_name = "session_token"]; // @gotags: validate:"required"
  string otp = 2 [json_name = "otp"]; // @gotags: validate:"required,len=6"
}

// VerifyRegistrationOTPResponse - Step 2 response
message VerifyRegistrationOTPResponse {
  bool success = 1;
  string message = 2;
  string session_token = 3 [json_name = "session_token"]; // Updated session token for step 3
}

// CompleteRegistrationRequest - Step 3: User provides name & password
message CompleteRegistrationRequest {
  string session_token = 1 [json_name = "session_token"]; // @gotags: validate:"required"
  string full_name = 2 [json_name = "full_name"]; // @gotags: validate:"required,min=2,max=100"
  string password = 3 [json_name = "password"]; // @gotags: validate:"required,min=8"
}

// CompleteRegistrationResponse - Step 3 response with auto-login tokens
message CompleteRegistrationResponse {
  string message = 1;
  Account account = 2;
  Token token = 3; // Auto-login: access & refresh tokens
}

// ========== ADDRESS MESSAGES ==========

// Address represents a user's shipping/billing address
message Address {
  string address_id = 1 [json_name = "address_id"];
  string user_id = 2 [json_name = "user_id"];
  string full_name = 3 [json_name = "full_name"];
  string phone_number = 4 [json_name = "phone_number"];
  string address_line1 = 5 [json_name = "address_line1"];
  string address_line2 = 6 [json_name = "address_line2"];
  string landmark = 7 [json_name = "landmark"];
  string city = 8 [json_name = "city"];
  string state = 9 [json_name = "state"];
  string postal_code = 10 [json_name = "postal_code"];
  string country = 11 [json_name = "country"];
  string address_type = 12 [json_name = "address_type"]; // shipping, billing, both
  bool is_default = 13 [json_name = "is_default"];
  string created_at = 14 [json_name = "created_at"];
  string updated_at = 15 [json_name = "updated_at"];
}

// AddAddressRequest - Add a new address
message AddAddressRequest {
  string full_name = 1 [json_name = "full_name"]; // @gotags: validate:"required,min=2,max=200"
  string phone_number = 2 [json_name = "phone_number"]; // @gotags: validate:"required,e164"
  string address_line1 = 3 [json_name = "address_line1"]; // @gotags: validate:"required,min=5,max=255"
  string address_line2 = 4 [json_name = "address_line2"]; // @gotags: validate:"omitempty,max=255"
  string landmark = 5 [json_name = "landmark"]; // @gotags: validate:"omitempty,max=255"
  string city = 6 [json_name = "city"]; // @gotags: validate:"required,min=2,max=100"
  string state = 7 [json_name = "state"]; // @gotags: validate:"required,min=2,max=100"
  string postal_code = 8 [json_name = "postal_code"]; // @gotags: validate:"required,min=4,max=20"
  string country = 9 [json_name = "country"]; // @gotags: validate:"required,min=2,max=100"
  string address_type = 10 [json_name = "address_type"]; // @gotags: validate:"required,oneof=shipping billing both"
  bool is_default = 11 [json_name = "is_default"];
}

// AddAddressResponse - Response after adding address
message AddAddressResponse {
  bool success = 1 [json_name = "success"];
  string message = 2 [json_name = "message"];
  Address address = 3 [json_name = "address"];
}

// GetAddressRequest - Get a specific address by ID
message GetAddressRequest {
  string address_id = 1 [json_name = "address_id"]; // @gotags: validate:"required"
}

// GetAddressResponse - Response with address details
message GetAddressResponse {
  bool success = 1 [json_name = "success"];
  string message = 2 [json_name = "message"];
  Address address = 3 [json_name = "address"];
}

// ListAddressesRequest - List all addresses for user
message ListAddressesRequest {
  optional string address_type = 1 [json_name = "address_type"]; // Optional filter: shipping, billing, both
}

// ListAddressesResponse - Response with list of addresses
message ListAddressesResponse {
  bool success = 1 [json_name = "success"];
  string message = 2 [json_name = "message"];
  repeated Address addresses = 3 [json_name = "addresses"];
  int32 total_count = 4 [json_name = "total_count"];
}

// UpdateAddressRequest - Update an existing address
message UpdateAddressRequest {
  string address_id = 1 [json_name = "address_id"]; // @gotags: validate:"required"
  string full_name = 2 [json_name = "full_name"]; // @gotags: validate:"required,min=2,max=200"
  string phone_number = 3 [json_name = "phone_number"]; // @gotags: validate:"required,e164"
  string address_line1 = 4 [json_name = "address_line1"]; // @gotags: validate:"required,min=5,max=255"
  string address_line2 = 5 [json_name = "address_line2"]; // @gotags: validate:"omitempty,max=255"
  string landmark = 6 [json_name = "landmark"]; // @gotags: validate:"omitempty,max=255"
  string city = 7 [json_name = "city"]; // @gotags: validate:"required,min=2,max=100"
  string state = 8 [json_name = "state"]; // @gotags: validate:"required,min=2,max=100"
  string postal_code = 9 [json_name = "postal_code"]; // @gotags: validate:"required,min=4,max=20"
  string country = 10 [json_name = "country"]; // @gotags: validate:"required,min=2,max=100"
  string address_type = 11 [json_name = "address_type"]; // @gotags: validate:"required,oneof=shipping billing both"
  bool is_default = 12 [json_name = "is_default"];
}

// UpdateAddressResponse - Response after updating address
message UpdateAddressResponse {
  bool success = 1 [json_name = "success"];
  string message = 2 [json_name = "message"];
  Address address = 3 [json_name = "address"];
}

// DeleteAddressRequest - Delete an address
message DeleteAddressRequest {
  string address_id = 1 [json_name = "address_id"]; // @gotags: validate:"required"
}

// DeleteAddressResponse - Response after deleting address
message DeleteAddressResponse {
  bool success = 1 [json_name = "success"];
  string message = 2 [json_name = "message"];
}

// SetDefaultAddressRequest - Set an address as default
message SetDefaultAddressRequest {
  string address_id = 1 [json_name = "address_id"]; // @gotags: validate:"required"
}

// SetDefaultAddressResponse - Response after setting default
message SetDefaultAddressResponse {
  bool success = 1 [json_name = "success"];
  string message = 2 [json_name = "message"];
  Address address = 3 [json_name = "address"];
}
